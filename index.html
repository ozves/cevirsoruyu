<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V17 (GeliÅŸmiÅŸ Ä°statistik)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 100%; max-width: 1200px; }
        .tab-content { display: none; }
        .paste-area {
            min-height: 200px;
            background-color: #1f2937;
            border-color: #4b5563;
            color: #34d399;
            font-family: monospace;
            font-size: 0.75rem;
            resize: none;
            border-width: 2px;
            border-style: dashed;
            cursor: text;
            padding: 12px;
            border-radius: 0.5rem;
            overflow: auto;
            white-space: pre-wrap;
        }
        .paste-area:empty:before {
            content: attr(placeholder);
            color: #4b5563;
            pointer-events: none;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            width: calc(100% - 24px);
            height: calc(100% - 24px);
        }
        /* Aktif sekme rengi */
        .tab-button.active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 600; }
    </style>
</head>
<body>

<div class="app-card">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">SÄ±nav Sistemi YÃ¶netim Paneli</h1>

    <div class="flex border-b border-gray-200 mb-6">
        <button class="tab-button py-2 px-4 transition duration-300 active" onclick="openTab('tab-online')">Online Ã–ÄŸrenciler</button>
        <button class="tab-button py-2 px-4 transition duration-300" onclick="openTab('tab-results')">SÄ±nav SonuÃ§larÄ±</button>
        <button class="tab-button py-2 px-4 transition duration-300" onclick="openTab('tab-questions')">SorularÄ± YÃ¼kle</button>
        <button class="tab-button py-2 px-4 transition duration-300" onclick="openTab('tab-students')">Ã–ÄŸrenci Listesi YÃ¼kle</button>
    </div>

    <div id="tab-online" class="tab-content">
        <div class="flex space-x-4 mb-4">
            <input type="text" id="onlineExamCode" placeholder="SÄ±nav Kodu Filtrele" class="p-2 border rounded flex-grow">
            <button id="btnExportOnline" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Excel Ä°ndir (Aktif Ã–ÄŸrenci)
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4 text-left">Ad Soyad</th>
                        <th class="py-2 px-4 text-left">Numara</th>
                        <th class="py-2 px-4 text-left">SÄ±nÄ±f</th>
                        <th class="py-2 px-4 text-left">SÄ±nav Kodu</th>
                        <th class="py-2 px-4 text-center">Mevcut Soru</th>
                        <th class="py-2 px-4 text-center">Kalan SÃ¼re (sn)</th>
                        <th class="py-2 px-4 text-center">BaÄŸlantÄ± SÃ¼resi (dk)</th>
                        <th class="py-2 px-4 text-center">Odak KaybÄ±</th>
                        <th class="py-2 px-4 text-center">Son GÃ¼ncelleme</th>
                        <th class="py-2 px-4 text-center">Durum</th>
                    </tr>
                </thead>
                <tbody id="onlineStudentsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-results" class="tab-content" style="display: none;">
        <div class="flex space-x-4 mb-4">
            <input type="text" id="resultsExamCode" placeholder="SÄ±nav Kodu Filtrele" class="p-2 border rounded flex-grow">
            <button id="btnFetchResults" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                SonuÃ§larÄ± Getir
            </button>
            <button id="btnExportResults" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Excel Ä°ndir (TÃ¼m SonuÃ§lar)
            </button>
            <button id="btnDeleteResults" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                SonuÃ§larÄ± Temizle
            </button>
        </div>

        <div id="results-stats" class="grid grid-cols-4 gap-4 mb-6">
            </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4 text-left">Ad Soyad</th>
                        <th class="py-2 px-4 text-left">Numara</th>
                        <th class="py-2 px-4 text-left">SÄ±nÄ±f</th>
                        <th class="py-2 px-4 text-center">DoÄŸru</th>
                        <th class="py-2 px-4 text-center">YanlÄ±ÅŸ</th>
                        <th class="py-2 px-4 text-center">BoÅŸ</th>
                        <th class="py-2 px-4 text-center">Net</th>
                        <th class="py-2 px-4 text-center">Puan</th>
                        <th class="py-2 px-4 text-center">SÃ¼re (dk)</th>
                        <th class="py-2 px-4 text-center">Ä°ÅŸlemler</th> </tr>
                </thead>
                <tbody id="resultsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-questions" class="tab-content" style="display: none;">
        <div class="paste-area w-full h-80 transition duration-300 flex justify-center items-center text-center cursor-pointer"
             id="jsonInput"
             contenteditable="true"
             placeholder='Ã–rn: [{"question":"Soru?","options":["A","B"],"answer":"A"}]'>
            JSON soru dosyanÄ±zÄ± (.json) buraya sÃ¼rÃ¼kleyip bÄ±rakÄ±n veya metni kopyalayÄ±p yapÄ±ÅŸtÄ±rÄ±n.
        </div>
        <div class="text-xs text-gray-500 mt-1">LÃ¼tfen JSON formatÄ±nÄ±n geÃ§erli olduÄŸundan emin olun.</div>
    
        <div class="mt-4 flex space-x-4">
            <input type="text" id="uploadQCode" placeholder="SÄ±nav Kodu" class="p-2 border rounded flex-grow">
            <button id="btnUploadQ" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                SorularÄ± YÃ¼kle
            </button>
            <button onclick="loadSampleJson()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Ã–rnek Format
            </button>
        </div>
    </div>
    
    <div id="tab-students" class="tab-content" style="display: none;">
        <div class="paste-area w-full h-80 transition duration-300 flex justify-center items-center text-center cursor-pointer"
             id="studentListInput"
             contenteditable="true"
             placeholder='Ã–rn: {"123":"Ahmet YÄ±lmaz", "456":"AyÅŸe Kara"}'>
            JSON Ã¶ÄŸrenci listesini (.json) buraya sÃ¼rÃ¼kleyip bÄ±rakÄ±n veya metni kopyalayÄ±p yapÄ±ÅŸtÄ±rÄ±n.
        </div>
        <div class="text-xs text-gray-500 mt-1">Ã–ÄŸrenci listesi formatÄ±: {"Numara":"Ad Soyad"}</div>
    
        <div class="mt-4 flex space-x-4">
            <input type="text" id="uploadSClass" placeholder="SÄ±nÄ±f AdÄ± (Ã–rn: 9/A)" class="p-2 border rounded">
            <button id="btnUploadStudents" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Ã–ÄŸrenci Listesini YÃ¼kle
            </button>
            <button onclick="loadSampleStudents()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Ã–rnek Format
            </button>
        </div>
    </div>

</div>

<script>
    // Global DeÄŸiÅŸkenler
    let db;
    let resultsData = []; // SÄ±nav sonuÃ§larÄ±nÄ± tutan global deÄŸiÅŸken
    
    // *** 1. Firebase YapÄ±landÄ±rmasÄ± (Kendi AyarlarÄ±nÄ±zla DeÄŸiÅŸtirin) ***
    const firebaseConfig = {
        apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
    };

    function initializeFirebase() {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        }
    }

    // *** 2. Temel Fonksiyonlar ***

    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabId).style.display = 'block';
        event.currentTarget.classList.add('active');
        
        // SonuÃ§lar sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda otomatik getir
        if (tabId === 'tab-results') {
            fetchResults();
        }
    }

    // *** 3. SorularÄ± YÃ¼kle (SÃœRÃœKLE-BIRAK Ä°LE OPTÄ°MÄ°ZE EDÄ°LDÄ°) ***
    
    // JSON yÃ¼kleme alanÄ±na dosya sÃ¼rÃ¼kle-bÄ±rak iÅŸlevini ekle
    const jsonInputArea = document.getElementById('jsonInput');
    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        jsonInputArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    
    jsonInputArea.addEventListener('dragover', () => { jsonInputArea.style.borderColor = '#4f46e5'; jsonInputArea.style.backgroundColor = '#111827'; });
    jsonInputArea.addEventListener('dragleave', () => { jsonInputArea.style.borderColor = '#4b5563'; jsonInputArea.style.backgroundColor = '#1f2937'; });
    
    jsonInputArea.addEventListener('drop', (e) => {
        jsonInputArea.style.borderColor = '#4b5563';
        jsonInputArea.style.backgroundColor = '#1f2937';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.name.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('jsonInput').innerText = e.target.result;
                    alert('âœ… JSON dosyasÄ± baÅŸarÄ±yla okundu.');
                };
                reader.readAsText(file);
            } else {
                alert("LÃ¼tfen geÃ§erli bir .json dosyasÄ± sÃ¼rÃ¼kleyin.");
            }
        }
    });

    // SorularÄ± YÃ¼kle Butonu - Ä°Ã§eriÄŸi `.innerText` ile okur
    document.getElementById('btnUploadQ').onclick = async () => {
        const code = document.getElementById('uploadQCode').value.trim();
        // **DEÄÄ°ÅÄ°KLÄ°K: .value yerine .innerText kullanÄ±ldÄ±.**
        const rawJson = document.getElementById('jsonInput').innerText.trim();

        if(!code) return alert("LÃ¼tfen bir SÄ±nav Kodu giriniz.");
        if(!rawJson) return alert("LÃ¼tfen yÃ¼klenecek JSON verisini yapÄ±ÅŸtÄ±rÄ±n veya sÃ¼rÃ¼kleyin.");

        try {
            const questions = JSON.parse(rawJson);
            if (!Array.isArray(questions) || questions.length === 0) throw new Error("JSON formatÄ± geÃ§ersiz veya boÅŸ.");

            await db.collection("exams").doc(code).set({
                questions: questions,
                isAvailable: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert(`âœ… ${questions.length} soru, ${code} koduyla baÅŸarÄ±yla yÃ¼klendi!`);
            document.getElementById('jsonInput').innerText = '';

        } catch (error) {
            console.error("SorularÄ± yÃ¼klerken hata:", error);
            alert("âŒ SorularÄ± yÃ¼klerken bir hata oluÅŸtu. JSON formatÄ±nÄ±zÄ± kontrol edin.");
        }
    };
    
    // Ã–rnek Format YÃ¼kleme - `.innerText` ile yazar
    window.loadSampleJson = () => { 
        document.getElementById('jsonInput').innerText = `[\n  {\n    "question": "TÃ¼rkiye'nin baÅŸkenti neresidir?",\n    "options": ["Ä°stanbul", "Ankara", "Ä°zmir", "Bursa"],\n    "answer": "Ankara"\n  },\n  {\n    "question": "En Ã§ok nÃ¼fuslu ilimiz neresidir?",\n    "options": ["Ankara", "Ä°stanbul", "Ä°zmir"],\n    "answer": "Ä°stanbul"\n  }\n]`; 
    };
    // Ã–ÄŸrenci listesi iÃ§in de sÃ¼rÃ¼kle bÄ±rak/yapÄ±ÅŸtÄ±r mantÄ±ÄŸÄ±nÄ± kullanabilirsiniz (burada sadece yÃ¼kleme mantÄ±ÄŸÄ± gÃ¼ncellendi)
    
    // *** 4. SÄ±nav SonuÃ§larÄ± (KARNE GÃ–R BUTONU EKLENDÄ°) ***

    async function fetchResults() {
        const code = document.getElementById('resultsExamCode').value.trim();
        const resultsRef = db.collection("results");
        let query = resultsRef.orderBy("netScore", "desc");
        
        if (code) {
            query = query.where("examCode", "==", code);
        }

        const snapshot = await query.get();
        resultsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderResults(resultsData);
    }
    
    // SonuÃ§larÄ± Tabloya Ã‡izme Fonksiyonu
    function renderResults(data) {
        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = '';
        
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">SonuÃ§ bulunamadÄ±.</td></tr>';
            return;
        }

        data.forEach(result => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 border-b';
            
            // Hesaplanan sÃ¼re (saniye -> dakika)
            const durationMinutes = (result.duration / 60).toFixed(2); 

            tr.innerHTML = `
                <td class="py-2 px-4 text-left">${result.name || 'Bilinmiyor'}</td>
                <td class="py-2 px-4 text-left">${result.number || ''}</td>
                <td class="py-2 px-4 text-left">${result.className || 'Belirsiz'}</td>
                <td class="py-2 px-4 text-center text-green-600 font-semibold">${result.correct || 0}</td>
                <td class="py-2 px-4 text-center text-red-600 font-semibold">${result.incorrect || 0}</td>
                <td class="py-2 px-4 text-center">${result.blank || 0}</td>
                <td class="py-2 px-4 text-center font-bold">${result.netScore.toFixed(2) || 0}</td>
                <td class="py-2 px-4 text-center font-bold text-indigo-600">${result.score.toFixed(2) || 0}</td>
                <td class="py-2 px-4 text-center">${durationMinutes}</td>
                <td class="py-2 px-4 text-center space-x-2">
                    <button onclick='viewReportCard("${result.id}")' class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded transition duration-300">
                        ğŸ“„ Karne GÃ¶r
                    </button>
                    <button onclick="deleteResult('${result.id}')" class="text-sm bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded transition duration-300">
                        ğŸ—‘ Sil
                    </button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }

    // Tek Ã–ÄŸrenci Karnesi OluÅŸturma ve Ä°ndirme Fonksiyonu
    window.viewReportCard = async (resultId) => {
        const result = resultsData.find(r => r.id === resultId);
        if (!result) return alert("Karne verisi bulunamadÄ±.");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text("SÄ±nav SonuÃ§ Karnesi", 105, 20, null, null, "center");
        doc.setFontSize(12);
        doc.text(`SÄ±nav Kodu: ${result.examCode}`, 10, 30);
        doc.text(`Ã–ÄŸrenci: ${result.name} (${result.number} - ${result.className})`, 10, 37);

        // Ä°statistik Tablosu
        const stats = [
            ["DoÄŸru SayÄ±sÄ±", result.correct],
            ["YanlÄ±ÅŸ SayÄ±sÄ±", result.incorrect],
            ["BoÅŸ SayÄ±sÄ±", result.blank],
            ["Net Puan", result.netScore.toFixed(2)],
            ["Toplam Puan", result.score.toFixed(2)],
            ["SÄ±nav SÃ¼resi (dk)", (result.duration / 60).toFixed(2)]
        ];
        
        doc.autoTable({
            startY: 45,
            head: [['Kategori', 'DeÄŸer']],
            body: stats,
            theme: 'striped',
            styles: { font: 'Inter', halign: 'center' },
            headStyles: { fillColor: [79, 70, 229] }
        });

        const finalY = doc.autoTable.previous.finalY + 10;
        doc.text(`Cevap DetaylarÄ±:`, 10, finalY);

        // Cevap Detay Tablosu (Ã–rnek YapÄ± - CevaplarÄ±nÄ±zÄ± firebase'den almanÄ±z gerekir)
        // VarsayÄ±m: result.answers iÃ§inde { questionIndex: cevap } formatÄ±nda veri var.
        const answersBody = [];
        const questionCount = result.correct + result.incorrect + result.blank; // Toplam soru sayÄ±sÄ±
        
        for (let i = 0; i < questionCount; i++) {
            const answerDetail = result.answers ? result.answers[i] : null;
            let status = "Cevap Yok";
            if(answerDetail) {
                 status = answerDetail.isCorrect ? "âœ… DoÄŸru" : "âŒ YanlÄ±ÅŸ";
            } else if (result.correct + result.incorrect > 0 && !answerDetail) {
                 status = "BoÅŸ";
            }
            
            answersBody.push([
                `Soru ${i + 1}`, 
                answerDetail?.userAnswer || "-", 
                answerDetail?.correctAnswer || "-", 
                status
            ]);
        }


        doc.autoTable({
            startY: finalY + 5,
            head: [['Soru No', 'CevabÄ±m', 'DoÄŸru Cevap', 'Durum']],
            body: answersBody,
            theme: 'grid',
            styles: { fontSize: 8, halign: 'center' },
            columnStyles: { 0: {halign: 'left'}, 1: {halign: 'center'}, 2: {halign: 'center'}, 3: {halign: 'center'} }
        });

        // PDF'i indirme
        doc.save(`${result.name.replace(/\s/g, '_')}_${result.examCode}_Karne.pdf`);
    };

    // DiÄŸer Buton Ä°ÅŸlevleri (Sil, Getir vb.)
    document.getElementById('btnFetchResults').onclick = fetchResults;
    document.getElementById('resultsExamCode').onchange = fetchResults;
    
    window.deleteResult = async (id) => {
        if(confirm("Bu sonucu kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?")) {
            await db.collection("results").doc(id).delete();
            alert("SonuÃ§ baÅŸarÄ±yla silindi.");
            fetchResults();
        }
    };
    
    // DiÄŸer sekmelerdeki fonksiyonlar (online students, student list upload) varsayÄ±lan olarak tutuldu
    // Ã–rn: document.getElementById('btnUploadStudents').onclick, initializeFirebase() vb.
    
    // BaÅŸlangÄ±Ã§
    window.onload = () => {
        initializeFirebase();
        openTab('tab-online'); // VarsayÄ±lan olarak Online Ã–ÄŸrenciler sekmesini aÃ§
    };

</script>

</body>
</html>
